name: release-pr

on:
  workflow_call:
    inputs:
      git_pr_release_branch_staging:
        type: string
        description: 'The branch name that the feature branches are merged into and is going to be merged into the "production" branch.'
        default: "release"
        required: false
      git_pr_release_branch_production:
        type: string
        description: "The branch name that is deployed in production environment."
        default: "main"
        required: false
      git_pr_release_template:
        type: string
        description: "The template file path (relative to the workidir top) for pull requests created. Its first line is used for the PR title, the rest for the body. This is an ERB template."
        default: ".git-pr-release-template"
        required: false
      git_pr_release_labels:
        type: string
        description: "The labels list for adding to pull requests created. This value should be comma-separated strings."
        default: ""
        required: false
      git_pr_release_assign_pr_author:
        type: boolean
        description: "Whether to assign the related users of the merged pull requests to the release pull request."
        default: false
        required: false
      git_pr_release_request_pr_author_review:
        type: boolean
        description: "Whether to request review from the related users of the merged pull requests on the release pull request."
        default: false
        required: false
      override:
        type: boolean
        description: "If this value is true, this action overrides an existing branch and a pull request."
        default: false
        required: false
    secrets:
      token:
        required: true
      slack_webhook:
        required: true

jobs:
  job:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.token }}
      GIT_PR_RELEASE_TOKEN: ${{ secrets.token }}
      GIT_PR_RELEASE_BRANCH_STAGING: ${{ inputs.git_pr_release_branch_staging }}
      GIT_PR_RELEASE_BRANCH_PRODUCTION: ${{ inputs.git_pr_release_branch_production }}
      GIT_PR_RELEASE_TEMPLATE: ${{ inputs.git_pr_release_template }}
      GIT_PR_RELEASE_LABELS: ${{ inputs.git_pr_release_labels }}
      GIT_PR_RELEASE_ASSIGN_PR_AUTHOR: ${{ inputs.git_pr_release_assign_pr_author }}
      GIT_PR_RELEASE_REQUEST_PR_AUTHOR_REVIEW: ${{ inputs.git_pr_release_request_pr_author_review }}
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0 # Need to fetch merge history
          ref: ${{ github.event.inputs.branch_name }} # checkout branch

      - name: Check if release target exists by comparing the production branch and the default branch
        run: |
          git log --merges origin/$GIT_PR_RELEASE_BRANCH_PRODUCTION..origin/$(git branch --show-current) --pretty=format:%h > commits.txt
          test -s commits.txt # if file is not empty, it goes to the next step

      - name: Check if release branch exists
        id: branch-check
        if: ${{ !inputs.override }}
        run: |
          if git branch -a --format="%(refname:short)" | grep -qx "origin/$GIT_PR_RELEASE_BRANCH_STAGING"; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Notify if branch already exists
        if: ${{ !inputs.override && steps.branch-check.outputs.exists == 'true' }}
        uses: slackapi/slack-github-action@91efab103c0de0a537f72a35f6b8cda0ee76bf0a # v2.1.1
        with:
          webhook: ${{ secrets.slack_webhook }}
          webhook-type: incoming-webhook
          payload: |
            attachments:
              - color: "warning"
                blocks:
                  - type: "section"
                    text:
                      type: "mrkdwn"
                      text: "*${{ github.repository }} - Release branch already exists*\nThe release branch '${{ inputs.git_pr_release_branch_staging }}' already exists. Please merge or delete the existing branch before creating a new one."

      - name: Exit if branch already exists
        if: ${{ !inputs.override && steps.branch-check.outputs.exists == 'true' }}
        run: |
          echo "Error: Release branch already exists. Exiting."
          exit 1

      - name: Create new Branch
        run: |
          git switch -c $GIT_PR_RELEASE_BRANCH_STAGING
          git push origin $GIT_PR_RELEASE_BRANCH_STAGING

      - name: Determine which Ruby version to use
        id: ruby-version-check
        run: |
          if [ -e ".ruby-version" ]; then
            echo "version=.ruby-version" >> $GITHUB_OUTPUT
          else
            echo "version=3.1.2" >> $GITHUB_OUTPUT
          fi

      - name: Set up Ruby
        uses: ruby/setup-ruby@d354de180d0c9e813cfddfcbdc079945d4be589b # v1.275.0
        with:
          ruby-version: ${{ steps.ruby-version-check.outputs.version }}
          bundler-cache: true

      - name: Create a release pull request
        run: |
          gem install -N git-pr-release
          git-pr-release

      - name: Fetch created pull request info
        id: fetch
        run: |
          gh pr view $GIT_PR_RELEASE_BRANCH_STAGING --json "body,number" -t '{{ .number }}{{ printf "\n" }}{{ .body }}' > pr.txt
          users=$(grep -o -E "@[a-zA-Z0-9]([a-zA-Z0-9]?|[\-]?([a-zA-Z0-9])){0,38}" pr.txt | sort -u | xargs echo)
          number=$(head -n 1 pr.txt)
          echo "users=${users}" >> $GITHUB_OUTPUT
          echo "number=${number}" >> $GITHUB_OUTPUT

      - name: Notify of Slack
        uses: slackapi/slack-github-action@91efab103c0de0a537f72a35f6b8cda0ee76bf0a # v2.1.1
        with:
          webhook: ${{ secrets.slack_webhook }}
          webhook-type: incoming-webhook
          payload: |
            attachments:
              - color: "#1DD0B0"
                blocks:
                  - type: "section"
                    text:
                      type: "mrkdwn"
                      text: "*${{ github.repository }} has changes to be released!*\nCheck <https://github.com/${{ github.repository }}/pull/${{ steps.fetch.outputs.number }}|PR #${{ steps.fetch.outputs.number }}> ${{ steps.fetch.outputs.users }}"
